<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explore | PoornimaX</title>
    <script src="https://kit.fontawesome.com/b8b432d7d3.js" crossorigin="anonymous"></script>
    <style>
        /* --- PoornimaX Modern Theme (Corrected & Enhanced) --- */

        :root {
            --primary: #3b82f6;      
            --primary-light: #60a5fa;
            --bg: #f8f9fa;            
            --bg-card: #ffffff;      
            --text: #1f2937;          
            --text-light: #6c757d;    
            --border: #e9ecef;        
            --shadow: rgba(0, 0, 0, 0.08); 
            --shadow-hover: rgba(0, 0, 0, 0.12);
            --radius: 12px;           
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* --- Base & Typography --- */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            scroll-behavior: smooth;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }
        
        body.popup-active {
            overflow: hidden;
        }

        a { text-decoration: none; color: inherit; }

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        /* --- Loader --- */
        .loader-container {
            position: fixed; inset: 0; background-color: var(--bg);
            display: grid; place-items: center; z-index: 9999;
            transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
        }
        .loader-container.hidden { opacity: 0; visibility: hidden; }
        .loader { display: flex; gap: 8px; }
        .loader div {
            width: 12px; height: 12px; border-radius: 50%;
            background-color: var(--primary);
            animation: pulse 1.4s ease-in-out infinite both;
        }
        .loader div:nth-child(1) { animation-delay: -0.32s; }
        .loader div:nth-child(2) { animation-delay: -0.16s; }
        @keyframes pulse {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
            40% { transform: scale(1.0); opacity: 1; }
        }

        /* --- Main Layout & Header --- */
        .container {
            max-width: 960px; margin: 0 auto;
            padding: 2rem 1.5rem 8rem 1.5rem; /* Bottom padding for nav */
            animation: fadeInUp 0.5s ease-out;
        }
        .page-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 2.5rem;
        }
        .page-header h1 {
            background: linear-gradient(45deg, var(--primary), var(--primary-light));
            background-clip: text; -webkit-background-clip: text; color: transparent;
            font-size: clamp(2rem, 5vw, 2.5rem); font-weight: 700;
        }
        .section-title {
            font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem;
            padding-bottom: 0.5rem; border-bottom: 2px solid var(--primary-light);
            display: inline-block;
        }

        /* --- Buttons (Unified Style) --- */
        .create-confession-btn {
            background: var(--primary); color: #ffffff;
            padding: 12px 22px; border-radius: var(--radius); border: 2px solid transparent;
            font-size: 1rem; font-weight: 600; cursor: pointer; transition: var(--transition);
            display: inline-flex; justify-content: center; align-items: center; gap: 8px;
        }
        .create-confession-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.25);
        }

        /* --- Search Section --- */
        .search-section { margin-bottom: 3rem; }
        .search-box { position: relative; }
        #searchInput {
            width: 100%; padding: 1rem 1.25rem 1rem 3rem;
            border: 1px solid var(--border); border-radius: var(--radius);
            font-size: 1rem; transition: var(--transition); background-color: var(--bg-card);
        }
        #searchInput:focus {
            outline: none; border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
        }
        .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-light); }
        #user-results { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .user-card {
            display: flex; align-items: center; gap: 1rem; padding: 1rem;
            background-color: var(--bg-card); border-radius: var(--radius);
            box-shadow: 0 2px 4px var(--shadow); transition: var(--transition);
        }
        .user-card:hover { transform: translateY(-4px); box-shadow: 0 5px 15px var(--shadow-hover); }
        .user-avatar { width: 44px; height: 44px; border-radius: 50%; object-fit: cover; background-color: var(--border); }
        .user-info .name { font-weight: 600; }
        .user-info .detail { font-size: 0.9rem; color: var(--text-light); }
        .no-results-card {
            background-color: var(--bg-card); border-radius: var(--radius);
            padding: 1.5rem; text-align: center; color: var(--text-light);
            box-shadow: 0 2px 4px var(--shadow); grid-column: 1 / -1; /* Span full width */
        }

        /* --- Confessions Grid --- */
        .confessions-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem; }
        .confession-card {
            background-color: var(--bg-card); border-radius: var(--radius);
            box-shadow: 0 4px 12px var(--shadow); display: flex; flex-direction: column;
            transition: var(--transition); animation: fadeInUp 0.5s ease forwards;
        }
        .confession-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px var(--shadow-hover); }
        .confession-content { padding: 1.5rem; flex-grow: 1; font-size: 1.05rem; }
        .confession-meta {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1rem 1.5rem; border-top: 1px solid var(--border);
            font-size: 0.9rem; color: var(--text-light);
        }
        .author-info { display: flex; align-items: center; gap: 0.75rem; font-weight: 500; }
        .author-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; background-color: var(--border); }
        .confession-actions { display: flex; align-items: center; gap: 1.25rem; }
        .action-btn {
            border: none; background: none; cursor: pointer; display: flex; align-items: center;
            gap: 0.5rem; transition: color 0.2s ease; font-size: 1rem; color: var(--text-light);
        }
        .action-btn:hover { color: var(--primary); }
        .action-btn.liked { color: #ef4444; font-weight: 600; }
        .action-btn.liked:hover { color: #dc2626; }

        /* --- Comment Popup (Blurred Background & New UI) --- */
        .popup-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(248, 249, 250, 0.5); /* Light, semi-transparent bg */
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .popup-overlay.visible { display: flex; animation: fadeIn 0.3s ease; }
        .popup {
            background-color: var(--bg-card); width: 90%; max-width: 550px; max-height: 90vh;
            border-radius: var(--radius); box-shadow: 0 15px 40px rgba(0,0,0,0.15);
            display: flex; flex-direction: column; animation: scaleIn 0.35s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .popup-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1rem 1.5rem; border-bottom: 1px solid var(--border);
        }
        .popup-header h3 { font-size: 1.25rem; }
        .close-btn { font-size: 1.75rem; color: var(--text-light); transition: color 0.2s ease, transform 0.2s ease; border: none; background: none; cursor: pointer; }
        .close-btn:hover { color: var(--text); transform: scale(1.1); }
        .popup-body { padding: 0 1.5rem; overflow-y: auto; flex-grow: 1; }
        
        /* New UI for confession content inside popup */
        .popup-confession-content {
            background-color: var(--bg); padding: 1.25rem; border-radius: 8px;
            margin: 1.5rem 0;
        }
        .popup-confession-content .author-details { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; }
        .popup-confession-content .author-avatar-popup { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; }
        .popup-confession-content .author-name-popup { font-weight: 600; color: var(--text); }
        .popup-confession-content .confession-quote {
            margin: 0; padding-left: 1rem;
            border-left: 3px solid var(--primary-light);
            font-style: italic; color: var(--text);
        }
        
        #commentList { padding-bottom: 1rem; }
        .comment-item {
            display: flex; gap: 1rem; padding: 1rem 0.5rem;
            border-bottom: 1px solid var(--border); animation: fadeInUp 0.6s ease;
        }
        .comment-item:first-child { border-top: 1px solid var(--border); }
        .comment-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; background-color: var(--border); margin-top: 4px; }
        .comment-body .user { font-weight: 600; font-size: 0.95rem; }
        .comment-body .time { font-size: 0.8rem; color: var(--text-light); margin-left: 0.5rem; }
        .comment-body .content { padding-top: 0.25rem; }

        .popup-footer {
            padding: 1rem 1.5rem; border-top: 1px solid var(--border);
            background-color: #fafbff; border-bottom-left-radius: var(--radius); border-bottom-right-radius: var(--radius);
        }
        #commentForm textarea {
            width: 100%; padding: 0.8rem 1rem; border: 1px solid var(--border);
            border-radius: 8px; resize: vertical; min-height: 60px;
            font-size: 1rem; margin-bottom: 0.75rem; transition: var(--transition);
        }
        #commentForm textarea:focus { outline: none; border-color: var(--primary); }
        .form-actions { display: flex; justify-content: space-between; align-items: center; }
        .anonymous-check { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--text-light); cursor: pointer; }
        .submit-comment-btn {
            background-color: var(--primary); color: white; padding: 0.6rem 1.4rem;
            border: none; border-radius: 8px; font-weight: 500; transition: var(--transition); cursor: pointer;
        }
        .submit-comment-btn:hover { background-color: #2563eb; }

        /* --- Bottom Navigation --- */
        nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            display: flex; justify-content: space-around; padding: 8px 0;
            box-shadow: 0 -2px 20px var(--shadow); border-top: 1px solid var(--border); z-index: 100;
        }
        nav a {
            display: flex; flex-direction: column; align-items: center;
            color: var(--text-light); padding: 8px 16px; transition: var(--transition);
        }
        nav a:hover { color: var(--primary); transform: translateY(-2px); }
        nav a.active-link { color: var(--primary); font-weight: 600; }
        nav a i { font-size: 22px; margin-bottom: 4px; }
    </style>
</head>
<body>
    
    <div class="loader-container" id="loaderContainer">
        <div class="loader"><div></div><div></div><div></div></div>
    </div>

    <div class="container">
        <header class="page-header">
            <h1>Explore</h1>
            <a href="{% url 'feed:confession' %}" class="create-confession-btn">
                <i class="fas fa-feather-alt"></i>
                <span>Create Confession</span>
            </a>
        </header>

        <section class="search-section">
            <h2 class="section-title">Find Users</h2>
            <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="searchInput" placeholder="Search by name or username...">
            </div>
            <div id="user-results"></div>
        </section>

        <section>
            <h2 class="section-title">Latest Confessions</h2>
            <div class="confessions-grid" id="confessionsGrid">
                {% for confession in confessions %}
                    <div class="confession-card" id="confession-{{ confession.id }}">
                        <div class="confession-content">{{ confession.content }}</div>
                        <div class="confession-meta">
                            
<div class="author-info">
    {% if confession.is_anonymous or not confession.user %}
        <img src="{% static 'ann.png' %}" alt="Anonymous" class="author-avatar">
        <span>Anonymous</span>
    {% else %}
        <img src="{% if confession.user.profile_picture %}{{ confession.user.profile_picture.url }}{% else %}{% static 'ann.png' %}{% endif %}" alt="{{ confession.user.username }}" class="author-avatar">
        <span>{{ confession.user.username }}</span>
    {% endif %}
</div>

                            <div class="confession-actions">
                                <button class="action-btn {% if confession.is_liked %}liked{% endif %}" onclick="likeConfession(event, {{ confession.id }})">
                                    <i class="{% if confession.is_liked %}fas{% else %}far{% endif %} fa-heart"></i>
                                    <span class="like-count">{{ confession.like_count }}</span>
                                </button>
                                <button class="action-btn" onclick="openCommentPopup({{ confession.id }})">
                                    <i class="far fa-comment"></i>
                                    <span class="comment-count">{{ confession.comment_count }}</span>
                                </button>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <p class="no-results-card">No confessions yet. Be the first to share one!</p>
                {% endfor %}
            </div>
        </section>
    </div>
    <div id="commentPopup" class="popup-overlay">
        <div class="popup">
            <header class="popup-header">
                <h3>Comments</h3>
                <button onclick="closeCommentPopup()" class="close-btn">&times;</button>
            </header>
            <div class="popup-body">
                <div id="popupConfessionContent" class="popup-confession-content">
                    <div class="author-details">
                        <img id="popupConfessionAuthorAvatar" src="{% static 'ann.png' %}" alt="Author" class="author-avatar-popup">
                        <span id="popupConfessionAuthorName" class="author-name-popup"></span>
                    </div>
                    <blockquote id="popupConfessionQuote" class="confession-quote">
                    </blockquote>
                </div>
    
                <div id="commentList" class="comment-list">
                    <div class="comment-item">
                        <img src="{% static 'ann.png' %}" alt="User" class="comment-avatar">
                        <div class="comment-body">
                            <div>
                                <span class="user">Anonymous</span>
                                <span class="time">Just now</span>
                            </div>
                            <p class="content">This is a placeholder comment.</p>
                        </div>
                    </div>
                </div>
            </div>
            <footer class="popup-footer">
                <form id="commentForm" onsubmit="submitComment(event)">
                    <textarea id="commentInput" name="content" placeholder="Write a thoughtful comment..." required></textarea>
                    <div class="form-actions">
                        <label class="anonymous-check">
                            <input type="checkbox" id="anonymousCheckbox" name="is_anonymous">
                            Post Anonymously
                        </label>
                        <button type="submit" class="submit-comment-btn">Post</button>
                    </div>
                </form>
            </footer>
        </div>
    </div>

    <nav>
        <a href="{% url 'feed:home' %}"><i class="fas fa-home"></i></a>
        <a href="{% url 'feed:explore' %}" class="active-link"><i class="fas fa-compass"></i></a>
        <a href="{% url 'feed:create_post' %}"><i class="fas fa-plus-circle"></i></a>
        <a href="{% url 'feed:friends_list' %}"><i class="fas fa-user-friends"></i></a>
        <a href="{% url 'chat:inbox' %}"><i class="fas fa-comment"></i></a>
    </nav>

<script>
    const csrfToken = '{{ csrf_token }}';
    
    // --- PAGE LOAD & UTILITIES ---
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => document.getElementById('loaderContainer').classList.add('hidden'), 500);
        document.getElementById('searchInput').addEventListener('input', debounce(handleSearch, 400));
    });

    function debounce(func, delay) {
        let timeout;
        return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); };
    }

    // --- REAL-TIME USER SEARCH ---
    async function handleSearch(event) {
        const query = event.target.value.trim();
        const resultsContainer = document.getElementById('user-results');
        if (query.length < 2) {
            resultsContainer.innerHTML = '';
            return;
        }
        try {
            const response = await fetch(`/feed/api/search-users/?q=${encodeURIComponent(query)}`);
            if (!response.ok) throw new Error(`Server responded with ${response.status}`);
            const data = await response.json();
            renderUsers(data.users);
        } catch (error) {
            console.error('Search error:', error);
            resultsContainer.innerHTML = '<div class="no-results-card" style="color: #ef4444;">Error fetching results.</div>';
        }
    }

    function renderUsers(users) {
        const resultsContainer = document.getElementById('user-results');
        if (users.length === 0) {
            // Use the new styled card for no results
            resultsContainer.innerHTML = '<div class="no-results-card">No users found for this search.</div>';
        } else {
            resultsContainer.innerHTML = users.map((user, index) => `
                <a href="/feed/profile/${user.id}/" class="user-card" style="animation: fadeInUp 0.5s ease ${index * 60}ms forwards;">
                    <img src="${user.profile_picture_url}" alt="${user.username}" class="user-avatar">
                    <div class="user-info">
                        <div class="name">${user.full_name}</div>
                        <div class="detail">@${user.username}</div>
                    </div>
                </a>
            `).join('');
        }
    }

    // --- LIKE FUNCTIONALITY ---
    async function likeConfession(event, confessionId) {
        event.stopPropagation();
        const button = event.currentTarget;
        try {
            const response = await fetch(`/feed/api/confession/like/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `confession_id=${confessionId}`
            });
            const data = await response.json();
            button.querySelector('.like-count').textContent = data.like_count;
            button.classList.toggle('liked', data.liked);
            button.querySelector('i').classList.toggle('fas', data.liked);
            button.querySelector('i').classList.toggle('far', !data.liked);
        } catch (error) { console.error('Like error:', error); }
    }

    // --- COMMENT POPUP LOGIC ---
    let currentConfessionId = null;
    const popup = document.getElementById('commentPopup');
    
    async function refreshComments(confessionId) {
        const commentListDiv = document.getElementById('commentList');
        const confessionContentDiv = document.getElementById('popupConfessionContent');
        
        // Clear previous content and show loading state
        commentListDiv.innerHTML = '<p class="no-results-card">Loading...</p>';
        confessionContentDiv.innerHTML = '';

        try {
            const response = await fetch(`/feed/api/confession/${confessionId}/details/`);
            if (!response.ok) throw new Error('Failed to fetch details');
            const data = await response.json();
            
            // Render the new confession UI in the popup
            confessionContentDiv.innerHTML = `
                <div class="popup-confession-content">
                    <div class="author-details">
                        <img src="${data.confession.author_avatar}" alt="${data.confession.author}" class="author-avatar-popup">
                        <span class="author-name-popup">${data.confession.author}</span>
                    </div>
                    <blockquote class="confession-quote">
                        ${data.confession.content}
                    </blockquote>
                </div>
            `;
            
            // Render the comments
            if (data.comments.length > 0) {
                commentListDiv.innerHTML = data.comments.map(comment => `
                    <div class="comment-item">
                        <img src="${comment.profile_picture_url}" alt="${comment.user}" class="comment-avatar">
                        <div class="comment-body">
                            <div>
                                <span class="user">${comment.user}</span>
                                <span class="time">${comment.time_since}</span>
                            </div>
                            <p class="content">${comment.content}</p>
                        </div>
                    </div>
                `).join('');
            } else {
                commentListDiv.innerHTML = '<p class="no-results-card">Be the first to comment!</p>';
            }
        } catch (error) {
            console.error('Error fetching comments:', error);
            commentListDiv.innerHTML = '<p class="no-results-card" style="color: #ef4444;">Could not load comments.</p>';
        }
    }
    
    function openCommentPopup(confessionId) {
        currentConfessionId = confessionId;
        popup.classList.add('visible');
        document.body.classList.add('popup-active');
        refreshComments(confessionId);
    }

    function closeCommentPopup() {
        popup.classList.remove('visible');
        document.body.classList.remove('popup-active');
        document.getElementById('commentForm').reset();
        currentConfessionId = null;
    }

    // Using your original, functional logic for submitting comments
    async function submitComment(event) {
        event.preventDefault();
        const form = event.target;
        const content = form.content.value.trim();
        const submitButton = form.querySelector('.submit-comment-btn');

        if (!content) return;
        
        submitButton.disabled = true;
        submitButton.textContent = 'Posting...';

        try {
            const response = await fetch(`/feed/api/confession/comment/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `confession_id=${currentConfessionId}&content=${encodeURIComponent(content)}&is_anonymous=${form.is_anonymous.checked}`
            });
            const data = await response.json();
            if (data.success) {
                form.reset(); 
                await refreshComments(currentConfessionId); // Refresh the comment list
                const commentCountSpan = document.querySelector(`#confession-${currentConfessionId} .comment-count`);
                if (commentCountSpan) {
                    commentCountSpan.textContent = data.comment_count;
                }
            } else {
                alert('Error: ' + (data.error || 'Could not post comment.'));
            }
        } catch (error) {
            console.error('Comment submission error:', error);
            alert('An unexpected error occurred. Please try again.');
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Post';
        }
    }

    // Close popup with Escape key
    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && popup.classList.contains('visible')) {
            closeCommentPopup();
        }
    });

</script>
</body>
</html>
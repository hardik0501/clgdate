{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PoornimaX - Home</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        :root {
            --primary-hue: 217;
            --primary: hsl(var(--primary-hue), 91%, 60%);
            --primary-light: hsl(var(--primary-hue), 93%, 68%);
            --primary-dark: hsl(var(--primary-hue), 91%, 55%);
            --primary-ultralight: hsl(var(--primary-hue), 100%, 97%);

            --text-dark: #111827;
            --text-main: #374151;
            --text-light: #6b7280;
            
            --bg-main: #f9fafb;
            --bg-card: #ffffff;
            --border-color: #e5e7eb;

            --danger: #ef4444;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);

            --radius-md: 0.75rem;  /* 12px */
            --radius-lg: 1rem;    /* 16px */
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Base & Reset */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        html { scroll-behavior: smooth; }
        body { background-color: var(--bg-main); color: var(--text-main); font-size: 16px; padding-bottom: 90px; }
        a { text-decoration: none; color: inherit; }
        button { cursor: pointer; border: none; background: transparent; font-family: inherit; }
        img { max-width: 100%; display: block; }
        
        .content-wrapper { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
        .main-content { max-width: 680px; margin: 0 auto; }

        /* Loading Animations */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        @keyframes slideInUp {
            from { 
                transform: translateY(30px); 
                opacity: 0; 
            }
            to { 
                transform: translateY(0); 
                opacity: 1; 
            }
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            color: var(--primary);
        }

        .loading-spinner i {
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }

        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 0 0 280px;
        }

        .skeleton-avatar {
            width: 80px;
            height: 80px;
            border-radius: var(--radius-md);
        }

        .skeleton-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .skeleton-line {
            height: 1rem;
            border-radius: 0.5rem;
        }

        .skeleton-line.short { width: 60%; }
        .skeleton-line.medium { width: 80%; }
        .skeleton-line.long { width: 100%; }

        .skeleton-post {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .skeleton-post-header {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            gap: 0.75rem;
        }

        .skeleton-post-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
        }

        .skeleton-post-image {
            width: 100%;
            height: 400px;
        }

        .skeleton-post-content {
            padding: 1rem;
        }

        /* Lazy Loading Intersection Observer Fade In */
        .fade-in {
            opacity: 0;
            transition: opacity 0.6s ease-in-out;
        }

        .fade-in.visible {
            opacity: 1;
            animation: slideInUp 0.6s ease-out;
        }

        /* Header */
        header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 1.25rem 0; margin-bottom: 1.5rem; 
        }
        .header-left h2 { font-size: 1.5rem; font-weight: 700; color: var(--text-dark); }
        .header-left h2 span {
            background: linear-gradient(45deg, var(--primary), var(--primary-light));
            background-clip: text; -webkit-background-clip: text; color: transparent;
        }
        header a img { 
            width: 50px; height: 50px; border-radius: 50%; object-fit: cover; 
            border: 3px solid var(--bg-card); box-shadow: 0 0 0 2px var(--primary);
        }
        
        /* Stats Section */
        .stats-container { margin-bottom: 2.5rem; }
        .stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        @media (min-width: 768px) { .stats { grid-template-columns: repeat(4, 1fr); } }

        .stat-card { 
            background: var(--bg-card); border-radius: var(--radius-lg); padding: 1.25rem; 
            text-align: center; border: 1px solid var(--border-color);
            transition: var(--transition);
        }
        .stat-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); }
        .stat-card-icon { 
            display: grid; place-items: center; width: 50px; height: 50px; 
            background: var(--primary-ultralight); border-radius: var(--radius-md); 
            margin: 0 auto 0.75rem; color: var(--primary); font-size: 1.5rem;
        }
        .stat-card p { font-size: 0.875rem; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 500; }
        .stat-card strong { font-size: 1.75rem; color: var(--text-dark); font-weight: 700; }

        /* Horizontal Section & User Cards */
        .horizontal-section { margin-bottom: 2.5rem; }
        .section-divider { height: 1px; background-color: var(--border-color); margin: 2.5rem 0; }
        .section-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 1rem; padding: 0 0.25rem;
        }
        .section-header-left { display: flex; align-items: center; gap: 0.75rem; }
        .section-header-left h2 { font-size: 1.25rem; font-weight: 600; color: var(--text-dark); }
        .section-count { 
            background-color: var(--primary-ultralight); color: var(--primary-dark); 
            font-size: 0.75rem; border-radius: 99px; padding: 0.25rem 0.6rem; font-weight: 600; 
        }

        .scroll-container-wrapper { position: relative; }
        .scroll-container { 
            display: flex; gap: 1rem; overflow-x: auto; 
            padding: 0.5rem 0.25rem 1.25rem; scrollbar-width: none; -ms-overflow-style: none;
            scroll-snap-type: x mandatory; scroll-behavior: smooth;
        }
        .scroll-container::-webkit-scrollbar { display: none; }

        .user-card { 
            flex: 0 0 280px; background-color: var(--bg-card); border-radius: var(--radius-lg); 
            box-shadow: var(--shadow-sm); overflow: hidden; display: flex; 
            border: 1px solid var(--border-color); transition: var(--transition);
            scroll-snap-align: start;
        }
        .user-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); }
        .profile-link { display: flex; padding: 1rem; flex: 1; overflow: hidden; gap: 1rem; align-items: center; }
        .profile-pic-container { width: 80px; height: 80px; border-radius: var(--radius-md); overflow: hidden; flex-shrink: 0; }
        .profile-pic { width: 100%; height: 100%; object-fit: cover; }
        .user-info { display: flex; flex-direction: column; justify-content: center; flex: 1; overflow: hidden; }
        .user-info h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.375rem; color: var(--text-dark); white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
        .user-info p { font-size: 0.8rem; color: var(--text-light); margin-bottom: 0.25rem; display: flex; align-items: center; white-space: nowrap; gap: 0.5rem; }
        .user-info p i { font-size: 0.75rem; color: var(--primary-light); }
        .heart-form { display: flex; align-items: center; padding-right: 0.75rem; }
        .heart-btn { width: 48px; height: 48px; border-radius: 50%; display: grid; place-items: center; }
        .heart-btn i { font-size: 1.5rem; transition: all 0.2s ease; }
        
        /* Scroll Arrows */
        .scroll-arrow {
            position: absolute; top: 50%; transform: translateY(-50%);
            width: 44px; height: 44px; border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.9);
            box-shadow: var(--shadow-md);
            color: var(--text-main);
            display: none;
            place-items: center; z-index: 10;
            transition: var(--transition);
        }
        .scroll-arrow:hover { background-color: var(--primary); color: white; }
        .scroll-arrow.left { left: -22px; }
        .scroll-arrow.right { right: -22px; }
        @media (min-width: 1024px) {
            .scroll-container-wrapper:hover .scroll-arrow { display: grid; }
        }

        /* Public Feed */
        .public-feed-section .section-header { padding: 0; }
        .post-grid { display: grid; gap: 2rem; }
        
        .post-card {
            background-color: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: var(--radius-lg); display: flex; flex-direction: column;
            transition: var(--transition);
        }
        
        .post-card:hover { box-shadow: var(--shadow-md); }
        
        .post-header { display: flex; align-items: center; padding: 0.75rem 1rem; gap: 0.75rem; }
        .post-header a { display: flex; align-items: center; gap: 0.75rem; font-weight: 600; font-size: 0.9rem; color: var(--text-dark); }
        .post-user-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; }
        
        .post-image-container { width: 100%; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); background-color: #000; }
        .post-image { width: 100%; height: auto; max-height: 75vh; object-fit: contain; }
        
        .post-actions { display: flex; align-items: center; padding: 0.5rem 0.75rem; gap: 0.5rem; }
        .post-action-btn { font-size: 1.5rem; color: var(--text-main); padding: 0.5rem; border-radius: 50%; }
        .post-action-btn:hover { background-color: var(--primary-ultralight); }
        .post-action-btn.liked i { color: var(--danger); }
        
        .post-caption { padding: 0 1rem 1rem; font-size: 0.9rem; line-height: 1.5; color: var(--text-main); }
        .post-caption a { display: inline; font-weight: 600; color: var(--text-dark); margin-right: 0.4rem; }
        
        .empty-card {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 2px dashed var(--border-color); background-color: transparent;
            border-radius: var(--radius-lg); padding: 3rem 1.5rem; text-align: center;
            color: var(--text-light); grid-column: 1 / -1; width: 100%;
        }
        .empty-card i { font-size: 2.5rem; color: var(--primary-light); margin-bottom: 1rem; }

        /* Load More Button */
        .load-more-container {
            display: flex;
            justify-content: center;
            padding: 2rem 0;
        }

        .load-more-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: var(--radius-lg);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .load-more-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .load-more-btn:disabled {
            background: var(--text-light);
            cursor: not-allowed;
            transform: none;
        }

        /* Bottom Nav */
        nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            display: flex; justify-content: space-around; padding: 0.5rem 0;
            border-top: 1px solid var(--border-color); z-index: 1000;
        }
        nav a { 
            display: flex; flex-direction: column; align-items: center; color: var(--text-light);
            padding: 0.5rem 1rem; transition: var(--transition);
        }
        nav a i { font-size: 1.5rem; margin-bottom: 2px; }
        nav a span { font-size: 0.65rem; font-weight: 500; }
        nav a.active-link { color: var(--primary); }
        nav a:active { transform: scale(0.95); }

        /* Comment Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); display: flex;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease; z-index: 2000;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        
        .modal-content {
            background: var(--bg-card); position: fixed; bottom: 0; left: 0; width: 100%;
            max-height: 85vh; border-top-left-radius: var(--radius-lg); border-top-right-radius: var(--radius-lg);
            display: flex; flex-direction: column; transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal-overlay.active .modal-content { transform: translateY(0); }
        .modal-header { padding: 1rem; border-bottom: 1px solid var(--border-color); text-align: center; position: relative; }
        .modal-header h3 { font-size: 1rem; font-weight: 600; color: var(--text-dark); }
        .modal-close-btn { position: absolute; top: 50%; right: 1rem; transform: translateY(-50%); font-size: 1.5rem; color: var(--text-light); width: 32px; height: 32px; line-height: 32px; }
        .comments-list { flex-grow: 1; overflow-y: auto; padding: 1rem; }
        .comment-item { display: flex; gap: 0.75rem; margin-bottom: 1rem; }
        .comment-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
        .comment-body { display: flex; flex-direction: column; }
        .comment-body strong { font-size: 0.9rem; font-weight: 600; color: var(--text-dark); }
        .comment-body p { font-size: 0.9rem; line-height: 1.4; word-break: break-word; }
        .comment-body time { font-size: 0.75rem; color: var(--text-light); margin-top: 0.25rem; }
        .no-comments { padding: 2rem; text-align: center; color: var(--text-light); }
        .comment-form-container { padding: 1rem; border-top: 1px solid var(--border-color); background: var(--bg-card); }
        #comment-form { display: flex; align-items: center; gap: 0.75rem; }
        .comment-textarea { flex-grow: 1; border: 1px solid var(--border-color); background: var(--bg-main); border-radius: 99px; padding: 0.75rem 1rem; font-size: 0.9rem; resize: none; }
        .comment-textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px hsl(var(--primary-hue), 91%, 60%, 0.2); }
        .btn-submit-comment { background: var(--primary); color: white; padding: 0.75rem; border-radius: 50%; font-weight: 600; flex-shrink: 0; width: 44px; height: 44px; display: grid; place-items: center; }
        .btn-submit-comment:disabled { background-color: var(--primary-light); cursor: not-allowed; }

        @media (min-width: 640px) {
            .modal-overlay { align-items: center; justify-content: center; }
            .modal-content {
                position: relative; width: 90%; max-width: 520px;
                max-height: 70vh; border-radius: var(--radius-lg);
                transform: translateY(0) scale(0.95); transition: transform 0.3s ease, opacity 0.3s ease;
                opacity: 0;
            }
            .modal-overlay.active .modal-content { transform: translateY(0) scale(1); opacity: 1; }
        }
    </style>
</head>

<body>
    <div class="content-wrapper">
        <header>
            <div class="header-left">
                <h2>Welcome, <span>{{ user.full_name|default:'User' }}</span></h2>
            </div>
            <a href="{% url 'feed:profile' user_id=user.id %}">
                <img src="{{ user.profile_picture.url|default:'/static/images/ann.png' }}" alt="Profile" loading="lazy">
            </a>
        </header>

        <section class="stats-container">
            <div class="stats">
                <a href="{% url 'feed:hearts_sent' %}" class="stat-card"><div class="stat-card-icon"><i class="fas fa-paper-plane"></i></div><p>Hearts Sent</p><strong id="hearts-sent-stat">{{ hearts_sent }}</strong></a>
                <a href="{% url 'feed:hearts_received' %}" class="stat-card"><div class="stat-card-icon"><i class="fas fa-heart"></i></div><p>Hearts Received</p><strong id="hearts-received-stat">{{ hearts_received }}</strong></a>
                <a href="{% url 'feed:friends_list' %}" class="stat-card"><div class="stat-card-icon"><i class="fas fa-user-group"></i></div><p>Friends</p><strong id="friends-stat">{{ friends }}</strong></a>
                <div class="stat-card"><div class="stat-card-icon"><i class="fas fa-eye"></i></div><p>Profile Views</p><strong id="profile-views-stat">{{ profile_views }}</strong></div>
            </div>
        </section>

        <div class="section-divider"></div>
        
        <section class="horizontal-section">
            <div class="section-header">
                <div class="section-header-left">
                    <h2>Recently Joined</h2>
                    <span class="section-count" id="recently-joined-count">{{ recently_joined|length }}</span>
                </div>
            </div>
            <div class="scroll-container-wrapper">
                <div class="scroll-container" id="recently-joined-container">
                    <!-- Initial loading skeleton -->
                    <div class="skeleton-card skeleton">
                        <div class="skeleton-avatar skeleton"></div>
                        <div class="skeleton-info">
                            <div class="skeleton-line short skeleton"></div>
                            <div class="skeleton-line medium skeleton"></div>
                            <div class="skeleton-line short skeleton"></div>
                        </div>
                    </div>
                    <div class="skeleton-card skeleton">
                        <div class="skeleton-avatar skeleton"></div>
                        <div class="skeleton-info">
                            <div class="skeleton-line short skeleton"></div>
                            <div class="skeleton-line medium skeleton"></div>
                            <div class="skeleton-line short skeleton"></div>
                        </div>
                    </div>
                </div>
                <button class="scroll-arrow left" data-target="recently-joined-container"><i class="fas fa-chevron-left"></i></button>
                <button class="scroll-arrow right" data-target="recently-joined-container"><i class="fas fa-chevron-right"></i></button>
            </div>
        </section>
        
        <div class="section-divider"></div>

        <section class="horizontal-section">
            <div class="section-header">
                <div class="section-header-left">
                    <h2>Same Year</h2>
                    <span class="section-count" id="same-year-count">{{ same_year|length }}</span>
                </div>
            </div>
            <div class="scroll-container-wrapper">
                <div class="scroll-container" id="same-year-container">
                    <!-- Loading skeleton -->
                    <div class="skeleton-card skeleton">
                        <div class="skeleton-avatar skeleton"></div>
                        <div class="skeleton-info">
                            <div class="skeleton-line short skeleton"></div>
                            <div class="skeleton-line medium skeleton"></div>
                            <div class="skeleton-line short skeleton"></div>
                        </div>
                    </div>
                </div>
                <button class="scroll-arrow left" data-target="same-year-container"><i class="fas fa-chevron-left"></i></button>
                <button class="scroll-arrow right" data-target="same-year-container"><i class="fas fa-chevron-right"></i></button>
            </div>
        </section>

        <div class="section-divider"></div>

        <section class="horizontal-section">
            <div class="section-header">
                <div class="section-header-left">
                    <h2>Same Department</h2>
                    <span class="section-count" id="same-department-count">{{ same_department|length }}</span>
                </div>
            </div>
            <div class="scroll-container-wrapper">
                <div class="scroll-container" id="same-department-container">
                    <!-- Loading skeleton -->
                    <div class="skeleton-card skeleton">
                        <div class="skeleton-avatar skeleton"></div>
                        <div class="skeleton-info">
                            <div class="skeleton-line short skeleton"></div>
                            <div class="skeleton-line medium skeleton"></div>
                            <div class="skeleton-line short skeleton"></div>
                        </div>
                    </div>
                </div>
                <button class="scroll-arrow left" data-target="same-department-container"><i class="fas fa-chevron-left"></i></button>
                <button class="scroll-arrow right" data-target="same-department-container"><i class="fas fa-chevron-right"></i></button>
            </div>
        </section>

        <div class="section-divider"></div>

        <section class="horizontal-section">
            <div class="section-header">
                <div class="section-header-left">
                    <h2>Same College</h2>
                    <span class="section-count" id="same-college-count">{{ same_college|length }}</span>
                </div>
            </div>
            <div class="scroll-container-wrapper">
                <div class="scroll-container" id="same-college-container">
                    <!-- Loading skeleton -->
                    <div class="skeleton-card skeleton">
                        <div class="skeleton-avatar skeleton"></div>
                        <div class="skeleton-info">
                            <div class="skeleton-line short skeleton"></div>
                            <div class="skeleton-line medium skeleton"></div>
                            <div class="skeleton-line short skeleton"></div>
                        </div>
                    </div>
                </div>
                <button class="scroll-arrow left" data-target="same-college-container"><i class="fas fa-chevron-left"></i></button>
                <button class="scroll-arrow right" data-target="same-college-container"><i class="fas fa-chevron-right"></i></button>
            </div>
        </section>

        <div class="section-divider"></div>

        <div class="main-content">
            <section class="public-feed-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2>Public Feed</h2>
                    </div>
                </div>
                <div class="post-grid" id="post-grid">
                    <!-- Initial loading skeletons -->
                    <div class="skeleton-post">
                        <div class="skeleton-post-header">
                            <div class="skeleton-post-avatar skeleton"></div>
                            <div class="skeleton-line medium skeleton"></div>
                        </div>
                        <div class="skeleton-post-image skeleton"></div>
                        <div class="skeleton-post-content">
                            <div class="skeleton-line long skeleton"></div>
                            <div class="skeleton-line medium skeleton"></div>
                        </div>
                    </div>
                    <div class="skeleton-post">
                        <div class="skeleton-post-header">
                            <div class="skeleton-post-avatar skeleton"></div>
                            <div class="skeleton-line medium skeleton"></div>
                        </div>
                        <div class="skeleton-post-image skeleton"></div>
                        <div class="skeleton-post-content">
                            <div class="skeleton-line long skeleton"></div>
                            <div class="skeleton-line short skeleton"></div>
                        </div>
                    </div>
                </div>
                
                <div class="load-more-container">
                    <button class="load-more-btn" id="load-more-posts" style="display: none;">
                        <span class="btn-text">Load More Posts</span>
                        <i class="fas fa-spinner loading-icon" style="display: none;"></i>
                    </button>
                </div>
            </section>
        </div>
    </div>
    
    <nav>
        <a href="{% url 'feed:home' %}" class="active-link"><i class="fas fa-home"></i></a>
        <a href="{% url 'feed:explore' %}"><i class="fas fa-compass"></i></a>
        <a href="{% url 'feed:create_post' %}"><i class="fas fa-plus-circle"></i></a>
        <a href="{% url 'feed:friends_list' %}"><i class="fas fa-user-friends"></i></a>
        <a href="{% url 'chat:inbox' %}" ><i class="fas fa-comment"></i></a>
    </nav>
    
    <div class="modal-overlay" id="comment-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Comments</h3>
                <button class="modal-close-btn" id="modal-close-button">&times;</button>
            </div>
            <div class="comments-list" id="comments-list-container"></div>
            <div class="comment-form-container">
                <form id="comment-form">
                    {% csrf_token %}
                    <textarea name="content" class="comment-textarea" placeholder="Add a comment..." required rows="1"></textarea>
                    <button type="submit" class="btn-submit-comment" id="btn-submit-comment-id" disabled><i class="fas fa-paper-plane"></i></button>
                </form>
            </div>
        </div>
    </div>

    <script>
    class LazyLoader {
        constructor() {
            this.postPage = 1;
            this.isLoading = false;
            this.hasMorePosts = true;
            this.sectionsLoaded = new Set();
            
            this.init();
        }

        init() {
            this.setupIntersectionObserver();
            this.loadInitialData();
            this.setupEventListeners();
        }

        setupIntersectionObserver() {
            this.observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                    }
                });
            }, {
                threshold: 0.1,
                rootMargin: '50px'
            });
        }

        async loadInitialData() {
            // Load horizontal sections with staggered timing for smooth experience
            setTimeout(() => this.loadHorizontalSection('recently-joined'), 100);
            setTimeout(() => this.loadHorizontalSection('same-year'), 300);
            setTimeout(() => this.loadHorizontalSection('same-department'), 500);
            setTimeout(() => this.loadHorizontalSection('same-college'), 700);
            
            // Load initial posts
            setTimeout(() => this.loadPosts(), 900);
        }

        async loadHorizontalSection(sectionType) {
            if (this.sectionsLoaded.has(sectionType)) return;
            
            const container = document.getElementById(`${sectionType}-container`);
            if (!container) return;

            try {
                const response = await fetch(`/feed/lazy-load/${sectionType}/`);
                if (!response.ok) throw new Error('Failed to load section');
                
                const data = await response.json();
                
                // Clear skeleton
                container.innerHTML = '';
                
                if (data.users && data.users.length > 0) {
                    data.users.forEach((user, index) => {
                        const userCard = this.createUserCard(user);
                        userCard.classList.add('fade-in');
                        container.appendChild(userCard);
                        
                        // Observe for intersection
                        this.observer.observe(userCard);
                        
                        // Staggered animation
                        setTimeout(() => {
                            userCard.classList.add('visible');
                        }, index * 100);
                    });
                    
                    // Update count
                    const countElement = document.getElementById(`${sectionType}-count`);
                    if (countElement) {
                        countElement.textContent = data.users.length;
                    }
                } else {
                    container.innerHTML = this.createEmptyCard(sectionType);
                }
                
                this.sectionsLoaded.add(sectionType);
            } catch (error) {
                console.error(`Error loading ${sectionType}:`, error);
                container.innerHTML = this.createErrorCard();
            }
        }

        createUserCard(user) {
            const card = document.createElement('div');
            card.className = 'user-card';
            card.dataset.userId = user.id;
            
            card.innerHTML = `
                <a href="/feed/profile/${user.id}/" class="profile-link">
                    <div class="profile-pic-container">
                        <img src="${user.profile_picture}" alt="Profile" class="profile-pic" loading="lazy">
                    </div>
                    <div class="user-info">
                        <h3>${user.full_name}</h3>
                        <p><i class="fas fa-graduation-cap"></i>${user.department || 'N/A'}</p>
                        <p><i class="fas fa-university"></i>${user.college || 'N/A'}</p>
                    </div>
                </a>
                <form class="heart-form">
                    <input type="hidden" name="csrfmiddlewaretoken" value="${this.getCsrfToken()}">
                    ${this.createHeartButton(user.crush_status)}
                </form>
            `;
            
            return card;
        }

        createHeartButton(crushStatus) {
            const buttons = {
                'mutual': '<button type="submit" name="crush_action" value="uncrush" class="heart-btn" title="Friend"><i class="fas fa-heart" style="color: #ef4444;"></i></button>',
                'sent': '<button type="submit" name="crush_action" value="uncrush" class="heart-btn" title="Sent"><i class="fas fa-heart" style="color: #ff6584;"></i></button>',
                'received': '<button type="submit" name="crush_action" value="send_crush" class="heart-btn" title="Send Heart Back"><i class="far fa-heart" style="color: rgba(255, 101, 132, 0.8);"></i></button>',
                'none': '<button type="submit" name="crush_action" value="send_crush" class="heart-btn" title="Send Heart"><i class="far fa-heart" style="color: var(--text-light);"></i></button>'
            };
            return buttons[crushStatus] || buttons['none'];
        }

        createEmptyCard(sectionType) {
            const messages = {
                'recently-joined': '<i class="fas fa-door-open"></i><p>No new users recently.</p>',
                'same-year': '<i class="fas fa-search-minus"></i><p>No one from your year has joined yet.</p>',
                'same-department': '<i class="fas fa-users-slash"></i><p>Looks quiet... No users from your department found.</p>',
                'same-college': '<i class="fas fa-school"></i><p>You\'re a pioneer! No other users from your college found.</p>'
            };
            
            return `<div class="empty-card fade-in visible">${messages[sectionType] || '<i class="fas fa-info-circle"></i><p>No users found.</p>'}</div>`;
        }

        createErrorCard() {
            return '<div class="empty-card fade-in visible"><i class="fas fa-exclamation-triangle"></i><p>Failed to load content. Please try again later.</p></div>';
        }

        async loadPosts() {
            if (this.isLoading) return;
            
            this.isLoading = true;
            const loadMoreBtn = document.getElementById('load-more-posts');
            const btnText = loadMoreBtn.querySelector('.btn-text');
            const loadingIcon = loadMoreBtn.querySelector('.loading-icon');
            
            if (this.postPage > 1) {
                btnText.style.display = 'none';
                loadingIcon.style.display = 'inline-block';
                loadingIcon.style.animation = 'spin 1s linear infinite';
                loadMoreBtn.disabled = true;
            }

            try {
                const response = await fetch(`/feed/lazy-load/posts/?page=${this.postPage}`);
                if (!response.ok) throw new Error('Failed to load posts');
                
                const data = await response.json();
                const postGrid = document.getElementById('post-grid');
                
                // Clear skeletons on first load
                if (this.postPage === 1) {
                    postGrid.innerHTML = '';
                }
                
                if (data.posts && data.posts.length > 0) {
                    data.posts.forEach((post, index) => {
                        const postCard = this.createPostCard(post);
                        postCard.classList.add('fade-in');
                        postGrid.appendChild(postCard);
                        
                        // Observe for intersection
                        this.observer.observe(postCard);
                        
                        // Staggered animation
                        setTimeout(() => {
                            postCard.classList.add('visible');
                        }, index * 150);
                    });
                    
                    this.postPage++;
                    this.hasMorePosts = data.has_more;
                    
                    // Show/hide load more button
                    if (this.hasMorePosts) {
                        loadMoreBtn.style.display = 'block';
                    } else {
                        loadMoreBtn.style.display = 'none';
                    }
                } else if (this.postPage === 1) {
                    postGrid.innerHTML = '<div class="empty-card fade-in visible"><i class="fas fa-images"></i><p>The public feed is empty. Be the first to share something!</p></div>';
                    loadMoreBtn.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading posts:', error);
                if (this.postPage === 1) {
                    document.getElementById('post-grid').innerHTML = '<div class="empty-card fade-in visible"><i class="fas fa-exclamation-triangle"></i><p>Failed to load posts. Please try again later.</p></div>';
                }
            } finally {
                this.isLoading = false;
                if (loadMoreBtn) {
                    btnText.style.display = 'inline';
                    loadingIcon.style.display = 'none';
                    loadMoreBtn.disabled = false;
                }
            }
        }

        createPostCard(post) {
            const card = document.createElement('div');
            card.className = 'post-card';
            card.id = `post-card-${post.id}`;
            
            card.innerHTML = `
                <div class="post-header">
                    <a href="/feed/profile/${post.user.id}/">
                        <img src="${post.user.profile_picture}" alt="${post.user.username}'s avatar" class="post-user-avatar">
                        <span>${post.user.full_name || post.user.username}</span>
                    </a>
                </div>
                <div class="post-image-container">
                    <img src="${post.image}" alt="Post by ${post.user.username}" class="post-image" loading="lazy">
                </div>
                <div class="post-actions">
                    <button class="post-action-btn like-btn ${post.is_liked ? 'liked' : ''}" data-post-id="${post.id}">
                        <i class="${post.is_liked ? 'fas fa-heart' : 'far fa-heart'}"></i>
                    </button>
                    <button class="post-action-btn comment-btn" data-post-id="${post.id}">
                        <i class="far fa-comment"></i>
                    </button>
                </div>
                ${post.caption ? `
                <div class="post-caption">
                    <a href="/feed/profile/${post.user.id}/">${post.user.full_name || post.user.username}</a>
                    ${post.caption}
                </div>
                ` : ''}
            `;
            
            return card;
        }

        setupEventListeners() {
            // Load more posts button
            document.getElementById('load-more-posts').addEventListener('click', () => {
                if (this.hasMorePosts && !this.isLoading) {
                    this.loadPosts();
                }
            });

            // Smooth scrolling for arrows
            document.addEventListener('click', (e) => {
                const scrollArrow = e.target.closest('.scroll-arrow');
                if (scrollArrow) {
                    const container = document.getElementById(scrollArrow.dataset.target);
                    if (container) {
                        const scrollAmount = container.clientWidth * 0.8;
                        const direction = scrollArrow.classList.contains('left') ? -1 : 1;
                        
                        container.scrollBy({
                            left: scrollAmount * direction,
                            behavior: 'smooth'
                        });
                    }
                }
            });
        }

        getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]').value;
        }
    }

    // Main application logic
    document.addEventListener('DOMContentLoaded', function() {
        const lazyLoader = new LazyLoader();
        const getCsrfToken = () => document.querySelector('[name=csrfmiddlewaretoken]').value;
        const commentModal = document.getElementById('comment-modal');
        const commentForm = document.getElementById('comment-form');
        const commentsListContainer = document.getElementById('comments-list-container');
        const commentTextarea = document.querySelector('.comment-textarea');
        const submitCommentBtn = document.getElementById('btn-submit-comment-id');
        let activePostId = null;

        const renderComment = (comment) => {
            return `
                <div class="comment-item fade-in visible">
                    <img src="${comment.user.profile_picture_url || '/static/images/ann.png'}" alt="${comment.user.username}" class="comment-avatar">
                    <div class="comment-body">
                        <strong>${comment.user.full_name || comment.user.username}</strong>
                        <p>${comment.content}</p>
                        <time>${new Date(comment.created_at).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata', dateStyle: 'medium', timeStyle: 'short' })}</time>
                    </div>
                </div>`;
        };
        
        const openCommentModal = async (postId) => {
            activePostId = postId;
            commentModal.classList.add('active');
            document.body.style.overflow = 'hidden';
            commentsListContainer.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner"></i></div>';
            
            try {
                const response = await fetch(`/feed/post/${postId}/comments/`);
                if (!response.ok) throw new Error(`Network response was not ok (${response.status})`);
                const data = await response.json();

                if (data.comments && data.comments.length > 0) {
                    commentsListContainer.innerHTML = data.comments.map(renderComment).join('');
                } else {
                    commentsListContainer.innerHTML = '<div class="no-comments"><p>No comments yet. Be the first!</p></div>';
                }
            } catch (error) {
                console.error('Failed to fetch comments:', error);
                commentsListContainer.innerHTML = '<div class="no-comments"><p>Could not load comments.</p></div>';
            }
        };

        const closeCommentModal = () => {
            commentModal.classList.remove('active');
            document.body.style.overflow = 'auto';
            commentForm.reset();
            activePostId = null;
            submitCommentBtn.disabled = true;
        };
        
        const handleHeartFormSubmit = (form) => {
            const button = form.querySelector('.heart-btn');
            const userCard = form.closest('.user-card');
            if (!userCard) return;

            const userId = userCard.dataset.userId;
            const action = button.value;
            const url = `/feed/crush_action/${userId}/`;
            const formData = new FormData(form);
            formData.append(button.name, button.value);

            // Add loading state
            const originalIcon = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner" style="animation: spin 1s linear infinite;"></i>';
            button.disabled = true;

            fetch(url, { method: 'POST', body: formData })
                .then(res => {
                    if (!res.ok) return Promise.reject(res);
                    return res.json();
                })
                .then(data => {
                    if (data.status === 'ok') {
                        document.getElementById('hearts-sent-stat').textContent = data.stats.hearts_sent;
                        document.getElementById('hearts-received-stat').textContent = data.stats.hearts_received;
                        document.getElementById('friends-stat').textContent = data.stats.friends;
                        
                        const icon = button.querySelector('i');
                        switch (data.new_crush_status) {
                            case 'mutual': 
                                button.value = 'uncrush'; 
                                button.innerHTML = '<i class="fas fa-heart" style="color: #ef4444;"></i>';
                                break;
                            case 'sent': 
                                button.value = 'uncrush'; 
                                button.innerHTML = '<i class="fas fa-heart" style="color: #ff6584;"></i>';
                                break;
                            case 'received': 
                                button.value = 'send_crush'; 
                                button.innerHTML = '<i class="far fa-heart" style="color: rgba(255, 101, 132, 0.8);"></i>';
                                break;
                            default: 
                                button.value = 'send_crush'; 
                                button.innerHTML = '<i class="far fa-heart" style="color: var(--text-light);"></i>';
                                break;
                        }
                    } else {
                        alert(`Error: ${data.message}`);
                        button.innerHTML = originalIcon;
                    }
                })
                .catch(err => {
                    console.error('Action error:', err);
                    button.innerHTML = originalIcon;
                })
                .finally(() => {
                    button.disabled = false;
                });
        };

        const handlePostLike = (button) => {
            const postId = button.dataset.postId;
            const originalIcon = button.innerHTML;
            
            // Add loading state
            button.innerHTML = '<i class="fas fa-spinner" style="animation: spin 1s linear infinite;"></i>';
            button.disabled = true;
            
            fetch(`/feed/post/${postId}/like/`, { 
                method: 'POST', 
                headers: { 'X-CSRFToken': getCsrfToken() }
            })
            .then(res => res.ok ? res.json() : Promise.reject('Failed to like post'))
            .then(data => {
                if (data.success) {
                    button.classList.toggle('liked', data.liked);
                    button.innerHTML = `<i class="${data.liked ? 'fas fa-heart' : 'far fa-heart'}"></i>`;
                } else {
                    button.innerHTML = originalIcon;
                }
            })
            .catch(err => {
                console.error('Like error:', err);
                button.innerHTML = originalIcon;
            })
            .finally(() => {
                button.disabled = false;
            });
        };

        const handleCommentSubmit = (event) => {
            event.preventDefault();
            if (!activePostId || submitCommentBtn.disabled) return;
            
            const originalContent = submitCommentBtn.innerHTML;
            submitCommentBtn.innerHTML = '<i class="fas fa-spinner" style="animation: spin 1s linear infinite;"></i>';
            submitCommentBtn.disabled = true;
            
            fetch(`/feed/post/${activePostId}/comment/`, { 
                method: 'POST', 
                body: new FormData(commentForm) 
            })
            .then(res => res.ok ? res.json() : Promise.reject('Failed to submit comment'))
            .then(data => {
                if (data.success && data.comment) {
                    const noCommentsEl = commentsListContainer.querySelector('.no-comments');
                    if (noCommentsEl) noCommentsEl.remove();
                    commentsListContainer.insertAdjacentHTML('beforeend', renderComment(data.comment));
                    commentsListContainer.scrollTop = commentsListContainer.scrollHeight;
                    commentForm.reset();
                    commentTextarea.style.height = 'auto';
                } else { 
                    alert("Error: " + (data.error || "Could not post comment.")); 
                }
            })
            .catch(err => {
                console.error('Comment submit error:', err);
                alert('Failed to post comment. Please try again.');
            })
            .finally(() => {
                submitCommentBtn.innerHTML = originalContent;
                submitCommentBtn.disabled = true;
            });
        };

        // Event Delegation for Dynamic Content
        document.body.addEventListener('click', (e) => {
            const likeBtn = e.target.closest('.like-btn');
            const commentBtn = e.target.closest('.comment-btn');

            if (likeBtn && !likeBtn.disabled) {
                handlePostLike(likeBtn);
            } else if (commentBtn) {
                openCommentModal(commentBtn.dataset.postId);
            } else if (e.target.matches('.modal-close-btn') || e.target.matches('.modal-overlay')) {
                closeCommentModal();
            }
        });

        document.body.addEventListener('submit', (e) => {
            if (e.target.matches('.heart-form')) {
                e.preventDefault();
                const button = e.target.querySelector('.heart-btn');
                if (!button.disabled) {
                    handleHeartFormSubmit(e.target);
                }
            } else if (e.target.matches('#comment-form')) {
                handleCommentSubmit(e);
            }
        });
        
        commentTextarea.addEventListener('input', () => {
            commentTextarea.style.height = 'auto';
            commentTextarea.style.height = (commentTextarea.scrollHeight) + 'px';
            submitCommentBtn.disabled = commentTextarea.value.trim() === '';
        });

        // Periodic updates
        const fetchUpdates = () => {
            fetch('/feed/get-home-updates/')
                .then(res => res.ok ? res.json() : Promise.reject(res))
                .then(data => {
                    document.getElementById('hearts-sent-stat').textContent = data.stats.hearts_sent;
                    document.getElementById('hearts-received-stat').textContent = data.stats.hearts_received;
                    document.getElementById('friends-stat').textContent = data.stats.friends;
                    document.getElementById('profile-views-stat').textContent = data.stats.profile_views;
                }).catch(err => console.error('Polling error:', err));
        };
        setInterval(fetchUpdates, 30000);
    });

    document.addEventListener('DOMContentLoaded', function() {
        console.log('=== POST LOADING DEBUG STARTED ===');
        
        // Test 1: Check if elements exist
        const postGrid = document.getElementById('post-grid');
        const loadMoreBtn = document.getElementById('load-more-posts');
        
        console.log('Post grid element:', postGrid);
        console.log('Load more button:', loadMoreBtn);
        
        if (!postGrid) {
            console.error('ERROR: post-grid element not found!');
            return;
        }
        
        // Test 2: Manual fetch to debug endpoint
        console.log('Testing debug endpoint...');
        fetch('/feed/debug-posts/')  // You'll need to add this URL
            .then(response => {
                console.log('Debug response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Debug data:', data);
            })
            .catch(error => {
                console.error('Debug fetch error:', error);
            });
        
        // Test 3: Manual fetch to lazy load endpoint
        console.log('Testing lazy load endpoint...');
        fetch('/feed/lazy-load/posts/?page=1')
            .then(response => {
                console.log('Lazy load response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);
                return response.text(); // Get as text first to see raw response
            })
            .then(text => {
                console.log('Raw response:', text);
                try {
                    const data = JSON.parse(text);
                    console.log('Parsed JSON:', data);
                    
                    if (data.posts && data.posts.length > 0) {
                        console.log('SUCCESS: Found', data.posts.length, 'posts');
                        console.log('First post:', data.posts[0]);
                    } else {
                        console.log('WARNING: No posts in response');
                    }
                } catch (e) {
                    console.error('JSON parse error:', e);
                }
            })
            .catch(error => {
                console.error('Lazy load fetch error:', error);
            });
        
        // Test 4: Check if LazyLoader is working
        setTimeout(() => {
            if (window.lazyLoader) {
                console.log('LazyLoader instance exists');
            } else {
                console.error('LazyLoader instance not found');
            }
            
            // Check post grid content
            const postGridContent = postGrid.innerHTML;
            console.log('Post grid content length:', postGridContent.length);
            console.log('Post grid content preview:', postGridContent.substring(0, 200));
            
            if (postGridContent.includes('skeleton')) {
                console.log('Still showing skeleton - posts may not have loaded');
            }
            
            if (postGridContent.includes('empty-card')) {
                console.log('Showing empty card - no posts found');
            }
            
            console.log('=== POST LOADING DEBUG COMPLETED ===');
        }, 2000);
    });
    
    // Enhanced error logging for fetch requests
    const originalFetch = window.fetch;
    window.fetch = function(...args) {
        console.log('FETCH REQUEST:', args[0]);
        return originalFetch.apply(this, args)
            .then(response => {
                console.log('FETCH RESPONSE:', args[0], 'Status:', response.status);
                return response;
            })
            .catch(error => {
                console.error('FETCH ERROR:', args[0], error);
                throw error;
            });
    };
    </script>
</body>
</html>